<div class="container pagetop">
  <div class="row justify_content_center">
    <div class="col-lg-1"></div>

    <div class="col-lg-10">
      <h3 class="title"><%= @livehouse.livehouse_name %>に寄付を行う</h3>
      <hr>
      <h5 class="title">支援内容</h5>
      <p class="annotation">以下の内容でサイトに寄付内容が公表されます</p>
      <div id="public_post">
        <p>お名前: <%= @donation.nickname %></p>
        <p>支援金額: <%= @donation.amount.to_s(:delimited) %>円</p>
        <p>メッセージ: <%= simple_format(@donation.message) %></p>
      </div>
      <hr>
      <h5 class="title">ご支援者様情報</h5>
      <p class="annotation">お名前とメールアドレスのみライブハウス運営者に共有される場合がありますが、その他は一切公開されません。</p>
      <div id="supporter_info">
        <p>ご支援者様本名: <%= @donation.name %> 様</p>
        <p>メールアドレス: <%= @donation.email %></p>
        <p>お電話番号: <%= @donation.phone %></p>
        <p>ご住所:<br>
          <%= @donation.zipcode %> <%= @donation.pref %><%= @donation.city %><%= @donation.street %><br>
          <%= @donation.bldg %>
        </p>
      </div>

      <script src="https://js.stripe.com/v3/"></script>

      <%= form_with model: @donation, local: true, id:"payment-form" do |f| %>
        <div id="card-element">
          <!-- Elements will create input elements here -->
        </div>

        <!-- We'll put the error messages in this element -->
        <div id="card-process" role="alert"></div>
        <div id="card-errors" role="alert"></div>

        <%= f.submit "規約に同意して支払いを実行する", data: {secret: @payment_intent.client_secret}, class: "btn btn-success", id:"submit" %>
      <% end %>

    </div>
  </div>
</div>


<%= javascript_tag do %>
  var stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');

  var elements = stripe.elements();

  // Set up Stripe.js and Elements to use in checkout form
  var style = {
    base: {
      color: "#32325d",
    }
  };

  var card = elements.create("card", { style: style });
  card.mount("#card-element");

  //display any errors
  card.addEventListener('change', ({error}) => {
  const displayError = document.getElementById('card-errors');
  if (error) {
      displayError.textContent = error.message;
    } else {
      displayError.textContent = '';
    }
  });

  var form = document.getElementById('payment-form');

  form.addEventListener('submit', function(ev) {
    ev.preventDefault();
    stripe.confirmCardPayment(<%= @payment_intent.client_secret %>, {
      payment_method: {
        card: card,
        billing_details: {
          name: "<%= @donation.nickname %>"
        }
      }
    }).then(function(result) {
      const displayError = document.getElementById('card-errors');
      if (result.error) {
        displayError.textContent = result.error.message;
        // Show error to your customer (e.g., insufficient funds)
        console.log(result.error.message);
      } else {
        // The payment has been processed!
        const displayProcess = document.getElementById('card-process');
        displayProcess.textContent = '処理中です。この画面を閉じないでください。';
        if (result.paymentIntent.status === 'succeeded') {
          displayProcess.textContent = '処理が完了しました';
          toastr.success("ありがとうございます。お支払いが正常に行われました。");
          // Show a success message to your customer
          // There's a risk of the customer closing the window before callback
          // execution. Set up a webhook or plugin to listen for the
          // payment_intent.succeeded event that handles any business critical
          // post-payment actions.
        }
      }
    });
  });

<% end %>
