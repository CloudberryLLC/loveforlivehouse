<div class="container pagetop">
  <div class="row justify_content_center">
    <div class="col-lg-1"></div>
    <div class="col-lg-10">

      <h3 class="title"><%= @livehouse.livehouse_name %>に支援を行う</h3>
      <p class="annotation red">ブラウザの更新ボタンは押さないでください。</p>
      <hr>

      <%= render 'confirmation_view' %>

      <div class="button__area center">
        <%= link_to 'ここまでの内容を修正する', edit_donation_path(hash: donation_token(@donation), id: @donation), class: "btn btn-info btn-sm" %>
      </div>

      <hr>

      <h5 class="title">支払情報の入力 <%= image_tag("powered_by_stripe.png", class: "stripe_badge") %></h5>
      <p class="annotation">
        ※クレジットカード、デビットカードが利用できます。<br>
        ※入力情報はサーバーに保存されず、安全に決済できます。
      </p>

      <script src="https://js.stripe.com/v3/"></script>

      <form id="payment-form">
        <div id="card-element" class="margin__vertical__2em"></div>
        <div id="card-process" role="alert"></div>
        <div id="card-errors" role="alert"></div>
        <div class="button__area center">
          <button id="submit" class= "btn btn-success" data-secret="<%= @payment_intent.client_secret %>">規約に同意して支払いを実行する</button>
        </div>
      </form>

    </div>
  </div>
</div>

<%= javascript_tag do %>
  var stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>', {
  stripeAccount: '<%= @user.stripe_user_id %>'
  });

  var elements = stripe.elements();

  // Set up Stripe.js and Elements to use in checkout form
  var style = {
    base: {
      iconColor: '#666ee8',
      color: '#31325f',
      fontWeight: 400,
      fontFamily:
        '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '15px',
      '::placeholder': {
        color: '#aab7c4',
      },
      ':-webkit-autofill': {
        color: '#666ee8',
      },
    },
  };

  var card = elements.create("card", { style: style, hidePostalCode: true });
  card.mount("#card-element");

  //display any errors
  card.addEventListener('change', ({error}) => {
  const displayError = document.getElementById('card-errors');
  if (error) {
      displayError.textContent = error.message;
    } else {
      displayError.textContent = '';
    }
  });

  var form = document.getElementById('payment-form');

  form.addEventListener('submit', function(ev) {
    ev.preventDefault();
    stripe.confirmCardPayment('<%= @payment_intent.client_secret %>', {
      payment_method: {
        card: card,
        billing_details: {
          name: "<%= @donation.nickname %>",
          email: "<%= @donation.email %>",
          phone: ("<%= @donation.phone %>" || null),
          address: {
            postal_code: ("<%= @donation.zipcode %>" || null),
            state: ("<%= @donation.pref %>" || null),
            city: ("<%= @donation.city %>" || null),
            line1: ("<%= @donation.street %>" || null),
            line2: ("<%= @donation.bldg %>" || null)
          }
        }
      }
    }).then(function(result) {
      const displayError = document.getElementById('card-errors');
      if (result.error) {
        displayError.textContent = result.error.message;
        // Show error to your customer (e.g., insufficient funds)
        console.log(result.error.message);
      } else {
        // The payment has been processed!
        const displayProcess = document.getElementById('card-process');
        displayProcess.textContent = '処理中です。この画面を閉じないでください。';
        if (result.paymentIntent.status === 'succeeded') {
          location.href = "<%= donation_payment_succeeded_path(hash: donation_token(@donation), id: @donation.id)%>";
        }
      }
    });
  });

<% end %>
